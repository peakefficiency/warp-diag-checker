name: Upload WARP Version to Cloudflare KV

on:
  schedule:
    # Runs at minute 13 past every hour
    - cron: '13 * * * *'

jobs:
  upload-warp-version:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Install Cloudflare WARP
        run: |
          # Install Cloudflare WARP 
          curl -fsSL https://pkg.cloudflareclient.com/pubkey.gpg | sudo gpg --yes --dearmor --output /usr/share/keyrings/cloudflare-warp-archive-keyring.gpg
          echo "deb [arch=amd64 signed-by=/usr/share/keyrings/cloudflare-warp-archive-keyring.gpg] https://pkg.cloudflareclient.com/ $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/cloudflare-client.list
          sudo apt-get update && sudo apt-get install cloudflare-warp

      - name: Get WARP Version
        id: warp_version
        run: |
          # Get the version of warp-cli and output it
          VERSION=$(warp-cli -V | awk '{print $2}')
          echo "WARP_VERSION=$VERSION" >> $GITHUB_ENV

      - name: Install Wrangler
        run: |
          # Install Wrangler CLI
          npm install -g @cloudflare/wrangler

      - name: Login to Cloudflare using Wrangler
        run: wrangler login
        env:
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}

      - name: Publish WARP Version to Cloudflare KV
        run: |
          # Publish the WARP version to Cloudflare KV
          wrangler kv:key put --namespace-id=KV_NAMESPACE_ID "linux-version" $WARP_VERSION
        env:
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          KV_NAMESPACE_ID: ${{ secrets.KV_NAMESPACE_ID }}
          WARP_VERSION: ${{ env.WARP_VERSION }}
